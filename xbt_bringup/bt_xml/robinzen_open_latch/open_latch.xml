<root>
    <!-- 
    inputs: 
      - latch_name
      - latch_pose
      - 
  -->
    <BehaviorTree ID="open latch">
        <Sequence name="open latch">

            <!-- position control -->
            <SwitchControllerAction 
                name="switch to joint trajectory controller"
                service_name="controller_manager/switch_controller"
                controller="scaled_pos_joint_traj_controller"
            />

            <!-- calculate pose to look at latch -->
            <TransformPoseAction
                name="calculate approach latch pose"
                input_pose="{latch_pose}"
                translation_xyz="-0.2;0;-0.05"
                output_pose="{approach_latch_pose}"
            />

            <!-- plan in line to look at latch -->
            <SimplePlanAction
                name="plan to approach latch pose"
                service_name="/planning_interface/simple_plan"
                mode="POSE_LINE"
                pose="{approach_latch_pose}"
                pose_frame_id="world"
                vel_scaling="0.05"
                acc_scaling="0.05"
                joint_trajectory="{joint_trajectory}"
            />

            <!-- move to look at latch -->
            <JointTrajectoryAction
                name="move to approach latch pose"
                server_name="/scaled_pos_joint_traj_controller/follow_joint_trajectory"
                joint_trajectory="{joint_trajectory}"
            /> 

            <!-- detect whether or not -->


            <!-- close gripper half way -->
            <GripperAction
                name="close gripper half way"
                server_name="/gripper_controller/gripper_cmd"
                position="0.4"
                max_effort="20"
            />   

            <!-- calculate find surface -->
            <TransformPoseAction
                name="calculate find surface pose"
                input_pose="{latch_pose}"
                translation_xyz="-0.05;0;0"
                quaternion_xyzw="0.7071068;0;0;0.7071068"
                output_pose="{find_surface_pose}"
            />

            <!-- plan to find surface pose -->
            <SimplePlanAction
                name="plan to approach latch pose"
                service_name="/planning_interface/simple_plan"
                mode="POSE_LINE"
                pose="{find_surface_pose}"
                pose_frame_id="world"
                vel_scaling="0.05"
                acc_scaling="0.05"
                joint_trajectory="{joint_trajectory}"
            />

            <!-- move to look at latch -->
            <JointTrajectoryAction
                name="move to approach latch pose"
                server_name="/scaled_pos_joint_traj_controller/follow_joint_trajectory"
                joint_trajectory="{joint_trajectory}"
            /> 


            <TriggerAction
                name="zero force torque sensor"
                service_name="/ur_hardware_interface/zero_ftsensor"
            />

                        

            <SleepAction 
                name="let force torque sensor zeroing take effect" 
                msec="2000"
            />

            <!-- switch to joint traj ctrl -->
            <SwitchControllerAction 
                name="switch to cartesian_compliance_controller_find_surface"
                service_name="controller_manager/switch_controller"
                controller="cartesian_compliance_controller_find_surface"
            />

            <FindSurfaceAction
                server_name="find_surface_action_server/find_surface"
                force_target="10"
                force_threshold="2"
                maximum_distance="0.1"
                maximum_duration="30"
            />

            <SwitchControllerAction 
                name="switch to joint trajectory controller"
                service_name="controller_manager/switch_controller"
                controller="scaled_pos_joint_traj_controller"
            />

            <!-- save current pose -->
            <DetectFrameAction 
                name="detect handle gripper frame"
                source_frame="tcp_link" 
                target_frame="world" 
                output_pose="{gripper_pose}"
                timeout="1000"
            />
            <TransformPoseAction
                name="calculate retreat handle pose"
                input_pose="{gripper_pose}"
                translation_xyz="-0.015;0;0"
                output_pose="{retreat_gripper_pose}"
            />
            

            <!-- plan to retract-->
            <SimplePlanAction
                name="plan to approach latch pose"
                service_name="/planning_interface/simple_plan"
                mode="POSE_LINE"
                pose="{retreat_gripper_pose}"
                pose_frame_id="world"
                vel_scaling="0.02"
                acc_scaling="0.02"
                joint_trajectory="{joint_trajectory}"
            />

            <!-- move to retract -->
            <JointTrajectoryAction
                name="move to approach latch pose"
                server_name="/scaled_pos_joint_traj_controller/follow_joint_trajectory"
                joint_trajectory="{joint_trajectory}"
            /> 


            <TriggerAction
                name="zero force torque sensor"
                service_name="/ur_hardware_interface/zero_ftsensor"
            />
            <SleepAction 
                name="let force torque sensor zeroing take effect" 
                msec="2000"
            />

            <!-- switch to compliance control-->
            <SwitchControllerAction 
                name="switch to compliance controller"
                service_name="controller_manager/switch_controller"
                controller="cartesian_compliance_controller_open_close_latch"
            />

            <!-- close gripper -->
            <GripperAction
                name="close gripper"
                server_name="/gripper_controller/gripper_cmd"
                position="0.8"
                max_effort="20"
            />   

            <DetectFrameAction 
                name="detect handle gripper frame"
                source_frame="tcp_link" 
                target_frame="world" 
                output_pose="{gripper_pose}"
                timeout="1000"
            />
            <TransformPoseAction
                name="calculate open latch pose"
                input_pose="{gripper_pose}"
                quaternion_xyzw="0.7071068;0;0;0.7071068"
                output_pose="{open_latch_pose}"
            /> 

            <SimplePlanAction
                name="plan to open latch pose"
                service_name="/planning_interface/simple_plan"
                mode="POSE_LINE"
                pose="{open_latch_pose}"
                pose_frame_id="world"
                vel_scaling="0.02"
                acc_scaling="0.02"
                joint_trajectory="{joint_trajectory}"
            />
            <CompliantTrajectoryAction
                name="pull handle with compliance"
                server_name="/compliant_traj_action_server/follow_compliant_trajectory"
                wrench="0;0;0;0;0;0"
                wrench_frame_id="world"
                joint_trajectory="{joint_trajectory}"
            />

            <!-- switch back to joint traj ctrl -->
            <SwitchControllerAction 
                name="switch to joint trajectory controller"
                service_name="controller_manager/switch_controller"
                controller="scaled_pos_joint_traj_controller"
            />

            <!-- open gripper -->
            <GripperAction
                name="open gripper"
                server_name="/gripper_controller/gripper_cmd"
                position="0.4"
                max_effort="20"
            /> 

            <!-- save current pose -->
            <DetectFrameAction 
                name="detect handle gripper frame"
                source_frame="tcp_link" 
                target_frame="world" 
                output_pose="{gripper_pose}"
                timeout="1000"
            />
            <TransformPoseAction
                name="calculate retreat handle pose"
                input_pose="{gripper_pose}"
                translation_xyz="-0.05;0;0"
                output_pose="{retreat_gripper_pose}"
            />

            <!-- retreat from handle -->
            <SimplePlanAction
                name="plan to move to test frame"
                service_name="/planning_interface/simple_plan"
                mode="POSE_LINE"
                pose="{retreat_gripper_pose}"
                pose_frame_id="world"
                vel_scaling="0.02"
                acc_scaling="0.02"
                joint_trajectory="{joint_trajectory}"
            />
            <JointTrajectoryAction
                name="retreat from handle"
                server_name="/scaled_pos_joint_traj_controller/follow_joint_trajectory"
                joint_trajectory="{joint_trajectory}"
            /> 

            <SimplePlanAction
                name="plan to move to test frame"
                service_name="/planning_interface/simple_plan"
                mode="POSE_LINE"
                pose="{approach_latch_pose}"
                pose_frame_id="world"
                vel_scaling="0.02"
                acc_scaling="0.02"
                joint_trajectory="{joint_trajectory}"
            />
            <JointTrajectoryAction
                name="retreat from handle"
                server_name="/scaled_pos_joint_traj_controller/follow_joint_trajectory"
                joint_trajectory="{joint_trajectory}"
            /> 
            

<!-- 



            


            <TransformPoseAction
                name="reorient latch pose to be closed latch pose"
                input_pose="{latch_pose}"
                quaternion_xyzw="-0.7071068;0;0;0.7071068"
                output_pose="{closed_latch_pose}"
            />

            <TransformPoseAction
                name="calculate approach latch pose from latch pose"
                input_pose="{closed_latch_pose}"
                translation_xyz="-0.2;0;0"
                output_pose="{approach_latch_pose}"
            />

            <TransformPoseAction
                name="calculate find surface pose from latch pose"
                input_pose="{closed_latch_pose}"
                translation_xyz="-0.05;0;0"
                output_pose="{find_surface_pose}"
            />




            reorient latch pose to gripper pose for opening
            calculate approach pose from latch pose
            calculate find surface pose 
            calculate pose to go from close to open



            <SwitchControllerAction 
                name="switch to joint trajectory controller"
                service_name="controller_manager/switch_controller"
                controller="scaled_pos_joint_traj_controller"
            />


            move_line to approach

            check for apriltag if it is open

            Sequence 
                move to gripper half open

                switch to compliance find surface
                approach surface
                switch to joint traj
                move back a little
                switch to compliance
                close gripper
                move to close pose
                switch to joint traj
                get tcp frame
                calculate retreat pose
                open gripper
                
                retreat

            Sequence -->

        </Sequence>
    </BehaviorTree>

</root>