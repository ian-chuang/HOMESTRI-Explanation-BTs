<root main_tree_to_execute="MainTree">
    <BehaviorTree ID="MainTree">
        <Sequence name="test sequence">


            <!-- switch to joint traj ctrl -->
            <SwitchControllerAction 
                name="switch to joint trajectory controller"
                service_name="controller_manager/switch_controller"
                controller="scaled_pos_joint_traj_controller"
            />

            <!-- move to search pose -->
            <SimplePlanAction
                name="plan to search target"
                service_name="/planning_interface/simple_plan"
                mode="JOINT"
                joints="0;-1.57;2.15;-3.71;-1.57;-3.14"
                vel_scaling="0.05"
                acc_scaling="0.05"
                joint_trajectory="{joint_trajectory}"
            />
            <JointTrajectoryAction
                name="move to search target"
                server_name="/scaled_pos_joint_traj_controller/follow_joint_trajectory"
                joint_trajectory="{joint_trajectory}"
            /> 

            <!-- detect tag pose -->
            <DetectFrameAction 
                name="detect tag pose"
                source_frame="tag_frame" 
                target_frame="world" 
                output_pose="{tag_pose}"
                wait_duration="1000"
                timeout="1000"
            />

            <!-- calculate poses for approaching tag -->
            <TransformPoseAction
                name="reorient tag pose to match world orientation"
                input_pose="{tag_pose}"
                quaternion_xyzw="-0.5;0.5;0.5;0.5"
                output_pose="{tag_pose}"
            />
            <TransformPoseAction
                name="calculate approach tag gripper pose"
                input_pose="{tag_pose}"
                translation_xyz="-0.3;0;-0.05"
                output_pose="{approach_tag_gripper_pose}"
            />

            <!-- move to approach tag gripper pose -->
            <SimplePlanAction
                name="plan to approach tag gripper pose"
                service_name="/planning_interface/simple_plan"
                mode="POSE_LINE"
                pose="{approach_tag_gripper_pose}"
                pose_frame_id="world"
                vel_scaling="0.03"
                acc_scaling="0.03"
                joint_trajectory="{joint_trajectory}"
            />
            <JointTrajectoryAction
                name="move to approach tag gripper pose"
                server_name="/scaled_pos_joint_traj_controller/follow_joint_trajectory"
                joint_trajectory="{joint_trajectory}"
            /> 

            <!-- detect tag frame again for a more accurate position-->
            <DetectFrameAction 
                name="detect tag pose"
                source_frame="tag_frame" 
                target_frame="world" 
                output_pose="{tag_pose}"
                wait_duration="1000"
                timeout="1000"
                qx="0.5"
                qy="-0.5"
                qz="-0.5"
                qw="0.5"
            />

            <!-- reorient pose again -->
            <TransformPoseAction
                name="reorient tag pose to match world frame orientation"
                input_pose="{tag_pose}"
                translation_xyz="0;0;0"
                quaternion_xyzw="-0.5;0.5;0.5;0.5"
                output_pose="{tag_pose}"
            />

            <!-- calculate latch 1 pose -->
            <TransformPoseAction
                name="calculate latch 1 pose"
                input_pose="{tag_pose}"
                translation_xyz="0;-0.2675;-0.04"
                output_pose="{latch_1_pose}"
            />

            <TransformPoseAction
                name="calculate latch 2 pose"
                input_pose="{tag_pose}"
                translation_xyz="0;-0.2675;-0.3876625"
                output_pose="{latch_2_pose}"
            />

            <!-- open latch 1 -->
            <SubTree
                ID="open latch"
                name="open latch 1"
                latch_name="latch 1"
                latch_pose="{latch_1_pose}"
            />

            <SubTree
                ID="open latch"
                name="open latch 2"
                latch_name="latch 2"
                latch_pose="{latch_2_pose}"
            />
            


        </Sequence>
    </BehaviorTree>
</root>