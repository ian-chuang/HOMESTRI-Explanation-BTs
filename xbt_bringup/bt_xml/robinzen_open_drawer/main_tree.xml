<root main_tree_to_execute="MainTree">
    <BehaviorTree ID="MainTree">
        <Sequence name="test sequence">
            <!-- switch to joint traj ctrl -->
            <SwitchControllerAction 
                name="switch to joint trajectory controller"
                service_name="controller_manager/switch_controller"
                controller="scaled_pos_joint_traj_controller"
            />

            <!-- move to search pose -->
            <SimplePlanAction
                name="plan to search target"
                service_name="/planning_interface/simple_plan"
                mode="JOINT"
                joints="0;-1.57;2.15;-3.71;-1.57;-3.14"
                vel_scaling="0.05"
                acc_scaling="0.05"
                joint_trajectory="{joint_trajectory}"
            />
            <JointTrajectoryAction
                name="move to search target"
                server_name="/scaled_pos_joint_traj_controller/follow_joint_trajectory"
                joint_trajectory="{joint_trajectory}"
            /> 

            <!-- detect tag pose -->
            <DetectFrameAction 
                name="detect tag pose"
                source_frame="tag_frame" 
                target_frame="world" 
                output_pose="{tag_pose}"
                wait_duration="1000"
                timeout="1000"
            />

            <!-- calculate poses for approaching tag -->
            <TransformPoseAction
                name="reorient tag pose to match world orientation"
                input_pose="{tag_pose}"
                translation_xyz="0;0;0"
                quaternion_xyzw="-0.5;0.5;0.5;0.5"
                output_pose="{tag_pose}"
            />
            <TransformPoseAction
                name="calculate approach tag gripper pose"
                input_pose="{tag_pose}"
                translation_xyz="-0.3;-0.05;0"
                quaternion_xyzw="-0.7071068;0;0;0.7071068"
                output_pose="{approach_tag_gripper_pose}"
            />

            <!-- move to approach tag gripper pose -->
            <SimplePlanAction
                name="plan to approach tag gripper pose"
                service_name="/planning_interface/simple_plan"
                mode="POSE"
                pose="{approach_tag_gripper_pose}"
                pose_frame_id="world"
                vel_scaling="0.05"
                acc_scaling="0.05"
                joint_trajectory="{joint_trajectory}"
            />
            <JointTrajectoryAction
                name="move to approach tag gripper pose"
                server_name="/scaled_pos_joint_traj_controller/follow_joint_trajectory"
                joint_trajectory="{joint_trajectory}"
            /> 


            <!-- detect tag frame again for a more accurate position-->
            <DetectFrameAction 
                name="detect tag pose"
                source_frame="tag_frame" 
                target_frame="world" 
                output_pose="{tag_pose}"
                wait_duration="1000"
                timeout="1000"
                qx="0.5"
                qy="-0.5"
                qz="-0.5"
                qw="0.5"
            />

            <!-- calculate poses for opening drawer-->
            <TransformPoseAction
                name="reorient tag pose to match world frame orientation"
                input_pose="{tag_pose}"
                translation_xyz="0;0;0"
                quaternion_xyzw="-0.5;0.5;0.5;0.5"
                output_pose="{tag_pose}"
            />
            <TransformPoseAction
                name="calculate handle pose"
                input_pose="{tag_pose}"
                translation_xyz="-0.08;0;-0.15"
                output_pose="{handle_pose}"
            />
            <TransformPoseAction
                name="calculate pull handle pose"
                input_pose="{handle_pose}"
                translation_xyz="-0.33;0;0"
                output_pose="{pull_handle_pose}"
            />
            <TransformPoseAction
                name="reorient handle pose for gripper"
                input_pose="{handle_pose}"
                quaternion_xyzw="-0.6532815;0.2705981;0.2705981;0.6532815"
                output_pose="{handle_gripper_pose}"
            />
            <TransformPoseAction
                name="reorient pull pose for gripper"
                input_pose="{pull_handle_pose}"
                quaternion_xyzw="-0.6532815;0.2705981;0.2705981;0.6532815"
                output_pose="{pull_handle_gripper_pose}"
            />
            <TransformPoseAction
                name="calculate approach handle pose"
                input_pose="{handle_gripper_pose}"
                translation_xyz="-0.15;0;0"
                output_pose="{approach_handle_gripper_pose}"
            />

            <!-- move to approach handle pose -->
            <SimplePlanAction
                name="plan to approach handle pose"
                service_name="/planning_interface/simple_plan"
                mode="POSE"
                pose="{approach_handle_gripper_pose}"
                pose_frame_id="world"
                vel_scaling="0.05"
                acc_scaling="0.05"
                joint_trajectory="{joint_trajectory}"
            />
            <JointTrajectoryAction
                name="move to approach handle pose"
                server_name="/scaled_pos_joint_traj_controller/follow_joint_trajectory"
                joint_trajectory="{joint_trajectory}"
            /> 

            <!-- open gripper -->
            <GripperAction
                name="open gripper"
                server_name="/gripper_controller/gripper_cmd"
                position="0"
                max_effort="20"
            />   
            
            <!-- approach handle -->
            <SimplePlanAction
                name="plan to move to handle gripper pose"
                service_name="/planning_interface/simple_plan"
                mode="POSE_LINE"
                pose="{handle_gripper_pose}"
                pose_frame_id="world"
                vel_scaling="0.02"
                acc_scaling="0.02"
                joint_trajectory="{joint_trajectory}"
            />
            <JointTrajectoryAction
                name="approach handle"
                server_name="/scaled_pos_joint_traj_controller/follow_joint_trajectory"
                joint_trajectory="{joint_trajectory}"
            /> 

            <!-- zero force torque sensor -->
            <TriggerAction
                name="zero force torque sensor"
                service_name="/ur_hardware_interface/zero_ftsensor"
            />
            <SleepAction 
                name="let force torque sensor zeroing take effect" 
                msec="1000"
            />

            <!-- switch to compliance control-->
            <SwitchControllerAction 
                name="switch to compliance controller"
                service_name="controller_manager/switch_controller"
                controller="cartesian_compliance_controller_follow_trajectory"
            />

            <!-- close gripper -->
            <GripperAction
                name="close gripper"
                server_name="/gripper_controller/gripper_cmd"
                position="0.8"
                max_effort="20"
            />    

            <!-- apply upwards wrench for few seconds to lift drawer up -->
            <SetTargetWrenchAction
                name="lift the drawer up slightly"
                msec="3000"
                wrench="0;0;30;0;0;0"
                wrench_frame_id="world"
            />

            <!-- pull drawer open -->
            <SimplePlanAction
                name="plan to move to test frame"
                service_name="/planning_interface/simple_plan"
                mode="POSE_LINE"
                pose="{pull_handle_gripper_pose}"
                pose_frame_id="world"
                vel_scaling="0.02"
                acc_scaling="0.02"
                joint_trajectory="{joint_trajectory}"
            />
            <CompliantTrajectoryAction
                name="pull handle with compliance"
                server_name="/compliant_traj_action_server/follow_compliant_trajectory"
                wrench="-8;0;30;0;0;0"
                wrench_frame_id="world"
                joint_trajectory="{joint_trajectory}"
            />

            <!-- stop applying wrench  -->
            <SetTargetWrenchAction
                name="stop lifting the drawer"
                msec="3000"
                wrench="0;0;0;0;0;0"
                wrench_frame_id="world"
            />

            <!-- save current pose -->
            <DetectFrameAction 
                name="detect handle gripper frame"
                source_frame="tcp_link" 
                target_frame="world" 
                output_pose="{handle_gripper_pose}"
                timeout="1000"
            />
            <TransformPoseAction
                name="calculate retreat handle pose"
                input_pose="{handle_gripper_pose}"
                translation_xyz="-0.15;0;0"
                output_pose="{retreat_handle_gripper_pose}"
            />

            <!-- switch back to joint traj ctrl -->
            <SwitchControllerAction 
                name="switch to joint trajectory controller"
                service_name="controller_manager/switch_controller"
                controller="scaled_pos_joint_traj_controller"
            />

            <!-- open gripper -->
            <GripperAction
                name="open gripper"
                server_name="/gripper_controller/gripper_cmd"
                position="0"
                max_effort="20"
            /> 

            <!-- retreat from handle -->
            <SimplePlanAction
                name="plan to move to test frame"
                service_name="/planning_interface/simple_plan"
                mode="POSE_LINE"
                pose="{retreat_handle_gripper_pose}"
                pose_frame_id="world"
                vel_scaling="0.02"
                acc_scaling="0.02"
                joint_trajectory="{joint_trajectory}"
            />
            <JointTrajectoryAction
                name="retreat from handle"
                server_name="/scaled_pos_joint_traj_controller/follow_joint_trajectory"
                joint_trajectory="{joint_trajectory}"
            /> 
            
            <!-- calculate poses for inspection -->
            <TransformPoseAction
                name="reorient tag pose to match world pose"
                input_pose="{handle_pose}"
                translation_xyz="-0.45;0;0.3"  
                output_pose="{raise_gripper_pose}"
            />
            <TransformPoseAction
                name="reorient tag pose to match world pose"
                input_pose="{raise_gripper_pose}"
                translation_xyz="0.2;0;0"  
                quaternion_xyzw="0;0.7071068;0;0.7071068"
                output_pose="{approach_inspect_gripper_pose}"
            />
            <TransformPoseAction
                name="reorient tag pose to match world pose"
                input_pose="{raise_gripper_pose}"
                translation_xyz="0.05;0;0"  
                output_pose="{inspect_gripper_pose}"
            />

            <!-- retreat from handle -->
            <SimplePlanAction
                name="raise over drawer"
                service_name="/planning_interface/simple_plan"
                mode="POSE_LINE"
                pose="{raise_gripper_pose}"
                pose_frame_id="world"
                vel_scaling="0.02"
                acc_scaling="0.02"
                joint_trajectory="{joint_trajectory}"
            />
            <JointTrajectoryAction
                name="raise over drawer"
                server_name="/scaled_pos_joint_traj_controller/follow_joint_trajectory"
                joint_trajectory="{joint_trajectory}"
            /> 

            <!-- do inspection stuff -->

            <!-- <TransformPoseAction
                name="calculate raise pose"
                input_pose="{retreat_handle_gripper_pose}"
                translation_xyz="0;0;0"
                quaternion_xyzw="0.6532815;-0.2705981;-0.2705981;0.6532815"
                output_pose="{raise_gripper_pose}"
            />

            raise pose
            <SimplePlanAction
                name="plan to approach handle pose"
                service_name="/planning_interface/simple_plan"
                mode="POSE"
                pose="{approach_handle_gripper_pose}"
                pose_frame_id="world"
                vel_scaling="0.05"
                acc_scaling="0.05"
                joint_trajectory="{joint_trajectory}"
            />
            <JointTrajectoryAction
                name="move to approach handle pose"
                server_name="/scaled_pos_joint_traj_controller/follow_joint_trajectory"
                joint_trajectory="{joint_trajectory}"
            />  -->

            <!-- calculate new approach pose-->
            <TransformPoseAction
                name="calculate approach pose"
                input_pose="{retreat_handle_gripper_pose}"
                output_pose="{approach_handle_gripper_pose}"
            />
            <SimplePlanAction
                name="go to approach handle pose"
                service_name="/planning_interface/simple_plan"
                mode="POSE_LINE"
                pose="{approach_handle_gripper_pose}"
                pose_frame_id="world"
                vel_scaling="0.02"
                acc_scaling="0.02"
                joint_trajectory="{joint_trajectory}"
            />
            <JointTrajectoryAction
                name="go to approach handle pose"
                server_name="/scaled_pos_joint_traj_controller/follow_joint_trajectory"
                joint_trajectory="{joint_trajectory}"
            /> 

            


        </Sequence>
    </BehaviorTree>
</root>